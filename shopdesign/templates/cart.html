<h2>‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ üõí</h2>

{% if items %}
    <ul id="cart-items">
        {% for item in items %}
            <li id="item-{{ item.id }}">
                {{ item.product.name }} - {{ item.quantity }} ‡∏ä‡∏¥‡πâ‡∏ô 
                <span>‡∏£‡∏≤‡∏Ñ‡∏≤: {{ item.product.price }} ‡∏ö‡∏≤‡∏ó</span>
                <button class="remove-from-cart" data-item-id="{{ item.id }}">‚ùå ‡∏•‡∏ö</button>
            </li>
        {% endfor %}
    </ul>

    <h3>üí∞ ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <span id="total-price">{{ total_price }}</span> ‡∏ö‡∏≤‡∏ó</h3>

    <!-- ‚úÖ ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î Modal ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô -->
    <button id="checkout-button" class="btn btn-primary">‚úÖ ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</button>

    <!-- ‚úÖ Modal ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô -->
    <div id="checkout-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>üí≥ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h3>
            
            <label>
                <input type="radio" name="payment_method" value="bank_transfer" checked> ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£
            </label><br>

            <button id="confirm-order-button" class="btn btn-success">üì¶ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</button>
        </div>
    </div>

{% else %}
    <p>‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤</p>
{% endif %}

<a href="/">üîô ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</a>

<style>
/* ‚úÖ Modal Styles */
.modal {
    display: none;
    position: fixed;
    z-index: 1;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    background-color: white;
    margin: 10% auto;
    padding: 20px;
    border-radius: 10px;
    width: 50%;
    text-align: center;
}

.close {
    float: right;
    font-size: 25px;
    cursor: pointer;
}
</style>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        let modal = document.getElementById("checkout-modal");
        let checkoutButton = document.getElementById("checkout-button");
        let closeButton = document.querySelector(".close");
        let confirmOrderButton = document.getElementById("confirm-order-button");
    
        // ‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î Modal
        checkoutButton.addEventListener("click", function () {
            modal.style.display = "block";
        });
    
        // ‚úÖ ‡∏õ‡∏¥‡∏î Modal
        closeButton.addEventListener("click", function () {
            modal.style.display = "none";
        });
    
        // ‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
        confirmOrderButton.addEventListener("click", function () {
            let selectedPaymentMethod = document.querySelector('input[name="payment_method"]:checked').value;
    
            fetch("/checkout/", {
                method: "POST",
                headers: {
                    "X-CSRFToken": getCSRFToken(),
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ payment_method: selectedPaymentMethod })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert("‚úÖ ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
                    modal.style.display = "none";
                    window.location.href = "/";  // ‚úÖ ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                } else {
                    alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô!");
                }
            })
            .catch(error => console.error("Error:", error));
        });
    
        // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
        let removeButtons = document.querySelectorAll(".remove-from-cart");
    
        removeButtons.forEach(button => {
            button.addEventListener("click", function () {
                let itemId = this.getAttribute("data-item-id");
    
                fetch(`/cart/remove/${itemId}/`, {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": getCSRFToken(),  
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        let itemElement = document.getElementById("item-" + itemId);
                        if (itemElement) {
                            itemElement.remove(); // ‚úÖ ‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÅ‡∏ö‡∏ö Real-time
                        }
                        updateCartCount();  // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô Navbar
                        updateTotalPrice(data.total_price);  // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°‡πÅ‡∏ö‡∏ö Real-time
                        checkIfCartEmpty(data.total_price);  // ‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏´‡∏°
                    } else {
                        alert("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ!");
                    }
                })
                .catch(error => console.error("Error:", error));
            });
        });
    
        function updateCartCount() {
            fetch("/cart/count/")
            .then(response => response.json())
            .then(data => {
                let cartCountElement = document.getElementById("cart-count");
                if (cartCountElement) {
                    cartCountElement.textContent = data.count;
                }
            })
            .catch(error => console.error("Error updating cart count:", error));
        }
    
        function updateTotalPrice(newTotalPrice) {
            let totalPriceElement = document.getElementById("total-price");
            if (totalPriceElement) {
                totalPriceElement.textContent = newTotalPrice.toFixed(2);  // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°‡πÉ‡∏´‡∏°‡πà
            }
        }
    
        function checkIfCartEmpty(newTotalPrice) {
            if (newTotalPrice === 0) {
                document.getElementById("cart-items").innerHTML = "<p>‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤</p>";
                document.getElementById("total-price").textContent = "0";  // ‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô 0
            }
        }
    
        function getCSRFToken() {
            let cookies = document.cookie.split(";");
            for (let cookie of cookies) {
                let [name, value] = cookie.trim().split("=");
                if (name === "csrftoken") {
                    return value;
                }
            }
            return "";
        }
    });
    </script>
    